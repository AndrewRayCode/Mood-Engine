<html>
    <head>
        <title>My first X3DOM page</title>
        <script type="text/javascript" src="http://www.x3dom.org/download/x3dom.js"> </script>
        <link rel="stylesheet" type="text/css" href="http://www.x3dom.org/download/x3dom.css"></link>
        <link rel="stylesheet" type="text/css" href="css/main.css"/>
    </head>
    <body>

        <x3d style="width:100%; height:100%; border:0; margin:0; padding:0;" id="x3d">
            <scene>

                <group id='root' render='false'>
                    <group DEF='theScene'>
                        <navigationInfo id="head" headlight='false' type='"EXAMINE"'></navigationInfo>
                        <background  skyColor="0 0 0"></background>

                        <PointLight
                            id='point'
                            on='TRUE'
                            intensity='0.9000'
                            color="1 1 1"
                            shadowIntensity='0.5'
                            shadowFilterSize="32"
                            shadowCascades="10"
                            location="0 0 0"
                            radius='800'></PointLight>

                        <inline url="./assets/scaffold.x3d"></inline>

                        <Transform translation="0 -100 0" rotation="1 0 0 -1.57">
                            <Shape>
                                <Appearance><Material diffuseColor="0.7 0.7 0.7"></Material></Appearance>
                                <Plane solid="false" size="200 200"></Plane>
                            </Shape>
                        </Transform>

                        <Transform translation="0 100 0" rotation="1 0 0 -1.57">
                            <Shape>
                                <Appearance><Material diffuseColor="0.7 0.7 0.7"></Material></Appearance>
                                <Plane solid="false" size="200 200"></Plane>
                            </Shape>
                        </Transform>

                        <Viewpoint
                            position="2.44723 13.11743 38.56844"
                            orientation="-0.99727 0.07070 -0.02151 0.42839"></Viewpoint>
                </group>
            </group>



            <group DEF='left'>
            <shape>
                <appearance>
                    <renderedTexture id="rtLeft" stereoMode="LEFT_EYE" update='ALWAYS'
                            dimensions='640 800 4' repeatS='false' repeatT='false'>
                        <viewpoint USE='vp' containerField='viewpoint'></viewpoint>
                        <background USE='bgnd' containerField='background'></background>
                        <!--group USE='left' containerField="excludeNodes"></group-->
                        <group USE='theScene' containerField="scene"></group>
                    </renderedTexture>
                    <composedShader>
                        <field name='tex' type='SFInt32' value='0'></field>
                        <field name='leftEye' type='SFFloat' value='1'></field>
                        <shaderPart type='VERTEX'>
                            attribute vec3 position;
                            attribute vec2 texcoord;

                            uniform mat4 modelViewProjectionMatrix;
                            varying vec2 fragTexCoord;

                            void main()
                            {
                                vec2 pos = sign(position.xy);
                                fragTexCoord = texcoord;

                                gl_Position = vec4((pos.x - 1.0) / 2.0, pos.y, 0.0, 1.0);
                                //gl_Position = vec4(pos.xy / 4.0 + vec2(-0.75,0.75), 0.0, 1.0);
                            }
                        </shaderPart>
                        <shaderPart DEF="frag" type='FRAGMENT'>
                            #ifdef GL_ES
                            precision highp float;
                            #endif

                            uniform sampler2D tex;
                            uniform float leftEye;
                            varying vec2 fragTexCoord;

                            void main()
                            {
                                float distortionScale = 0.7; //0.685;
                                //float distortionK[4] = float[](1.0, 0.22, 0.24, 0.0);
                                vec2 lensCenter = vec2(0.151976495726, 0.0);
                                if (leftEye == 0.0) {
                                    lensCenter.x *= -1.0;
                                }

                                vec2 theta = (fragTexCoord * 2.0) - 1.0;
                                float rSq = theta.x * theta.x + theta.y * theta.y;
                                vec2 rvec = theta * (1.0 + 0.22 * rSq + 0.24 * rSq * rSq); //+ 0.0 * rSq * rSq * rSq);
                                vec2 texCoord = (distortionScale*rvec+(1.0-distortionScale)*lensCenter + 1.0) / 2.0;

                                if (any(notEqual(clamp(texCoord, vec2(0.0, 0.0), vec2(1.0, 1.0)) - texCoord,
                                                       vec2(0.0, 0.0)))) {
                                    //if (leftEye == 0.0) gl_FragColor = vec4(1.0,1.0,0.0,1.0);
                                    //else gl_FragColor = vec4(1.0,0.0,0.0,1.0);
                                    discard;
                                }
                                else {
                                    vec3 col = texture2D(tex, texCoord).rgb;
                                    gl_FragColor = vec4(col, 1.0);
                                }
                                //gl_FragColor = texture2D(tex, fragTexCoord);
                            }
                        </shaderPart>
                    </composedShader>
                </appearance>
                <plane solid="false"></plane>
            </shape>
        </group>
        <group DEF='right'>
            <shape>
                <appearance>
                    <renderedTexture id="rtRight" stereoMode="RIGHT_EYE" update='ALWAYS'
                                     dimensions='640 800 4' repeatS='false' repeatT='false'>
                        <viewpoint USE='vp' containerField='viewpoint'></viewpoint>
                        <background USE='bgnd' containerField='background'></background>
                        <group USE='theScene' containerField="scene"></group>
                    </renderedTexture>
                    <composedShader>
                        <field name='tex' type='SFInt32' value='0'></field>
                        <field name='leftEye' type='SFFloat' value='0'></field>
                        <shaderPart type='VERTEX'>
                            attribute vec3 position;
                            attribute vec2 texcoord;

                            uniform mat4 modelViewProjectionMatrix;
                            varying vec2 fragTexCoord;

                            void main()
                            {
                                vec2 pos = sign(position.xy);
                                fragTexCoord = texcoord;

                                gl_Position = vec4((pos.x + 1.0) / 2.0, pos.y, 0.0, 1.0);
                            }
                        </shaderPart>
                        <shaderPart USE="frag" type='FRAGMENT'>
                        </shaderPart>
                    </composedShader>
                </appearance>
                <plane solid="false"></plane>
            </shape>
        </group>

            </scene>
        </x3d>


        <script src="js/main.js"></script>

    </body>
</html>
